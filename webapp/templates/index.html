<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Great Clips Coupon Scraper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .status-box {
            background: #f5f5f5;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 25px;
        }
        
        .status-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .status-value {
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }
        
        .status-value.idle {
            color: #666;
        }
        
        .status-value.running {
            color: #f39c12;
        }
        
        .status-value.completed {
            color: #27ae60;
        }
        
        .status-value.error {
            color: #e74c3c;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        button {
            flex: 1;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .secondary {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }
        
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .logs-container {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            display: none;
        }
        
        .logs-container.active {
            display: block;
        }
        
        .log-line {
            color: #333;
            line-height: 1.6;
            padding: 2px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .log-line.error {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .info {
            background: #e8f4f8;
            border: 1px solid #b3e5fc;
            color: #01579b;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 20px;
            line-height: 1.5;
        }
        
        a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Coupon Scraper</h1>
        <p class="subtitle">Run your scraping script and view results online</p>
        
        <div class="status-box">
            <div class="status-label">Current Status</div>
            <div class="status-value idle" id="statusText">Ready</div>
        </div>
        
        <div class="status-box" id="lastRunBox" style="display: none; border-left-color: #27ae60;">
            <div class="status-label">Last Run</div>
            <div style="font-size: 14px; color: #333;" id="lastRunTime">-</div>
        </div>
        
        <div class="button-group">
            <button id="runBtn" onclick="runScript()">Run Script</button>
            <button class="secondary" onclick="window.location.href='/dashboard'">View Results</button>
        </div>
        
        <div class="logs-container" id="logsContainer">
            <div id="logsList"></div>
        </div>
        
        <div class="info">
            <strong>‚ÑπÔ∏è Tip:</strong> Click "View Results" to see stats, search offers, and browse the JSON data after running the script.
        </div>
    </div>
    
    <script>
        const statusText = document.getElementById('statusText');
        const runBtn = document.getElementById('runBtn');
        const logsContainer = document.getElementById('logsContainer');
        const logsList = document.getElementById('logsList');
        let isRunning = false;
        let statusCheckInterval;
        let lastLogCount = 0;
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDateTime(dateTimeString) {
            // Parse ISO format datetime: "2026-02-13 15:03:59"
            try {
                const dt = new Date(dateTimeString.replace(' ', 'T'));
                const options = { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                };
                return dt.toLocaleDateString('en-US', options);
            } catch (e) {
                return dateTimeString;
            }
        }
        
        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    isRunning = data.running;
                    const status = data.status;
                    
                    statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    statusText.className = 'status-value ' + status.split(':')[0].toLowerCase();
                    
                    if (isRunning) {
                        runBtn.disabled = true;
                        runBtn.innerHTML = '<span class="spinner"></span>Running...';
                        logsContainer.classList.add('active');
                    } else {
                        runBtn.disabled = false;
                        runBtn.innerHTML = 'Run Script';
                        if (status === 'completed') {
                            runBtn.innerHTML = '‚úì Run Script';
                        }
                    }
                    
                    // Update logs only if there are new ones
                    if (data.logs && data.logs.length > lastLogCount) {
                        lastLogCount = data.logs.length;
                        logsList.innerHTML = data.logs.map(log => {
                            const isError = log.includes('ERROR') || log.includes('error');
                            return `<div class="log-line ${isError ? 'error' : ''}">${escapeHtml(log)}</div>`;
                        }).join('');
                        // Auto scroll to bottom
                        logsContainer.scrollTop = logsContainer.scrollHeight;
                    }
                    
                    // Update last run time from the scrape log
                    fetch('/api/stats')
                        .then(r => r.json())
                        .then(stats => {
                            if (stats.session_start && stats.session_start !== 'No data yet') {
                                document.getElementById('lastRunBox').style.display = 'block';
                                document.getElementById('lastRunTime').textContent = formatDateTime(stats.session_start);
                            }
                        })
                        .catch(() => {});
                    
                    // If running, keep polling frequently; if idle, poll less often
                    if (isRunning && !statusCheckInterval) {
                        statusCheckInterval = setInterval(updateStatus, 1000);  // Every 1 second when running
                    } else if (!isRunning && statusCheckInterval) {
                        clearInterval(statusCheckInterval);
                        statusCheckInterval = null;
                    }
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                });
        }
        
        function runScript() {
            if (isRunning) return;
            
            lastLogCount = 0;  // Reset log count
            
            fetch('/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateStatus();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusText.textContent = 'Error';
                statusText.className = 'status-value error';
            });
        }
        
        // Initial status check
        updateStatus();
    </script>
</body>
</html>